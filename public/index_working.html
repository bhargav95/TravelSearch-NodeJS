<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Travel</title>

    <!--jQuery-->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <!--angular-->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-animate.min.js"></script>
    <!--bootstrap-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!--google places autocomplete-->
    <link rel="stylesheet" href="bower_components/angular-google-places-autocomplete/src/autocomplete.css">

    <!--font-awesome-->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

    <!-- maps api -->
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD3s6OJpYDXIgCj0EZST4oOvKjVdsL8qLc&libraries=places"></script>

    <!-- Google Places Autocomplete directive -->
    <script async src="./bower_components/angular-google-places-autocomplete/src/autocomplete.js"></script>

    <!-- <script src="bower_components/at-table/dist/angular-table.min.js"></script> -->

    <!-- angular bootstrap -->
    <script src="bower_components/angular-bootstrap/ui-bootstrap.min.js"></script>

    <!--moment-->
    <script async src="javascripts/moment.min.js"></script>

    <!-- rateyo -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rateYo/2.3.2/jquery.rateyo.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/rateYo/2.3.2/jquery.rateyo.min.js"></script>

    <style>
        body {
            font-size: 16px;
        }

        .form-group.required .control-label:after {
            content: "*";
            color: red;
        }


        .fas.fa-star {
            color: gold;
        }

        .img-gallery {
            display: flex;
            flex-wrap: wrap;
        }

        img {
            display: inline-block;
            flex-basis: 25%;
        }

        .icons {
            height: 40px;
        }

        .table-responsive {
            white-space: nowrap;
        }

        .main-form {
            padding: 20px;
        }


        .navigateButtons {
            margin-top: 30px;
        }

        .container-fluid {
            margin-top: 40px;
        }

        .margintop {
            margin-top: 40px;
        }

        .tab-pane {
            margin-top: 20px;
        }

        #map {
            height: 450px;
            width: 100%;
        }

        html {
            font-size: 1rem;
        }

        .alert-warning {
            margin-top: 50px;
        }

        .btn-white {
            background-color: white;
            border: 1px solid lightgray;
        }

    </style>
</head>

<body ng-app="myApp" ng-controller="myCtrl">

    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-lg-8 offset-lg-2 col-xl-6 offset-xl-3">
                <form class="bg-light border rounded main-form" name="myForm">
                    <h4 class="text-center">Travel and Entertainment Search</h4>
                    <div class="form-group required row">
                        <label for="keyword" class="col-sm-3 control-label col-form-label">Keyword</label>
                        <div class="col-sm-6">
                            <input required name="keyword" ng-model="keyword" type="text" class="form-control" ng-class="{'is-invalid': myForm.keyword.$touched && myForm.keyword.$invalid}" id="keyword">
                            <div class="invalid-feedback">
                                Please enter a keyword.
                            </div>
                        </div>
                    </div>

                    <div class="form-group required row">
                        <label for="category" class="col-sm-3 col-form-label">Category</label>
                        <div class="col-sm-6">
                            <select ng-model="category" class="form-control" id="category" ng-options="i for i in types">
                        </select>
                        </div>
                    </div>

                    <div class="form-group required row">
                        <label for="distance" class="col-sm-3 col-form-label">Distance  (miles)</label>
                        <div class="col-sm-6">
                            <input autocomplete="off" ng-model="distance" type="text" class="form-control" id="distance" placeholder="10">
                        </div>
                    </div>

                    <div class="form-group required row">
                        <label for="from" class="col-sm-3 control-label col-form-label">From</label>
                        <div class="col-sm-6">
                            <div class="form-check">
                                <input value="option1" ng-model="radio" class="form-check-input" type="radio" name="location" id="curloc" checked>
                                <label class="form-check-label" for="curloc">
                    Current location
                  </label>
                            </div>
                            <div class="form-check">
                                <input value="option2" ng-model="radio" class="form-check-input" type="radio" name="location" id="otherloc">
                                <label class="form-check-label" for="otherloc">
                        Other, Please specify:
                    </label>
                                <input autocomplete="off" required name="place" id="place" class="form-control" g-places-autocomplete ng-model="place" placeholder="Enter a location" ng-class="{'is-invalid': myForm.place.$touched && myForm.place.$invalid && radio == 'option2'}" ng-disabled="radio == 'option1'" />
                                <div class="invalid-feedback">
                                    Please enter a location.
                                </div>
                            </div>
                        </div>
                    </div>


                    <button ng-click="myFunc()" type="submit" class="btn btn-primary" id='searchbutton' disabled ng-disabled="(myForm.keyword.$invalid) || (myForm.place.$invalid && radio == 'option2') || (done==0)">
                <i class="fa fa-search"></i> Search</button>
                    <button type="button" class="btn btn-white" ng-click="clearall()">Clear</button>
                </form>
            </div>
        </div>

        <div class="row align-items-center">
            <div class="col-xl-8 offset-xl-2">
                <div class="margintop">
                    <ul class="nav nav-pills justify-content-center">
                        <li class="nav-item">
                            <a ng-click="changeactive(1)" class="nav-link" ng-class="{'active': isactive(0)}" data-toggle="tab" href="#ress">Results</a>
                        </li>
                        <li class="nav-item">
                            <a ng-click="changeactive(0)" class="nav-link" ng-class="{'active': isactive(1)}" data-toggle="tab" href="#favs">Favorites</a>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div ng-show="infoflag!=1" id="ress" role="tabpanel" class="tab-pane fade show active">

                            <!--No records found-->

                            <div class="alert alert-warning" role="alert" ng-show="isempty(groups) && table==2">
                                No Records.
                            </div>

                            <div class="progress" ng-show="table==1" style="margin-top: 40px">
                                <div class="progress-bar progress-bar-striped" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>


                            <!--Results Table-->

                            <div ng-show="groups.length>0 && table==2">
                                <button ng-disabled="recents==undefined" style="margin-bottom: 20px" class="btn btn-white float-right" ng-click='placedetails( recents )'>
                                    Details <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <div ng-show="groups.length>0 && table==2" class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Category</th>
                                            <th>Name</th>
                                            <th>Address</th>
                                            <th>Favorite</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-class="{'table-warning':isrecent(student.place_id)}" ng-repeat="student in groups[selectedIndex]">
                                            <td>{{$index+1+selectedIndex*resultsPerPage}}</td>
                                            <td><img class="icons img-thumbnail" ng-src="{{student.icon}}" alt="a"></td>
                                            <td>{{ student.name }}</td>
                                            <td>{{ student.vicinity }}</td>
                                            <td><button class="btn btn-white favourite_icon" ng-click='favorite(student)'><i class="fa-star favourite_icon" ng-class="{'far':!islocal(),'fas':islocal()}"></i></button></td>
                                            <td>
                                                <button class="btn btn-white" ng-click='placedetails( student.place_id )'>
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!--Prev Next Navigation-->
                            <div ng-show="table==2" class="navigateButtons text-center">
                                <button class="btn btn-white" ng-click="backwardIndex()" ng-show="selectedIndex!=0">Previous</button>
                                <button class="btn btn-white" ng-click="forwardIndex()" ng-show="selectedIndex<groups.length-1">Next</button>
                            </div>

                        </div>

                        <!-- Favorites Tab -->

                        <div ng-show="infoflag!=1" id="favs" role="tabpanel" class="tab-pane fade show">

                            <div ng-show="favs.length>0">
                                <button ng-disabled="recents==undefined" style="margin-bottom: 20px" class="btn btn-white float-right" ng-click='placedetails( recents )'>
                                    Details <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>

                            <div class="alert alert-warning" role="alert" ng-show="isempty(favs)">
                                No Records.
                            </div>

                            <div ng-show="favs.length>0" class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Category</th>
                                            <th>Name</th>
                                            <th>Address</th>
                                            <th>Favorite</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-class="{'table-warning':isrecent(x.place_id)}" ng-repeat="x in favs track by $index">
                                            <td>{{$index+1}}</td>
                                            <td><img class="icons img-thumbnail" ng-src="{{x.icon}}" alt="a"></td>
                                            <td>{{ x.name }}</td>
                                            <td>{{ x.vicinity }}</td>
                                            <td><button class="btn" ng-click='trash(x)'><i class="fa fa-trash"></i></button></td>
                                            <td>
                                                <button class="btn btn-white" ng-click='placedetails(x.place_id)'>
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>


                    <!-- Info tab -->
                    <div class="margintop" ng-show="infoflag==1" ng-repeat="dop in detailsofplace">

                        <div class="row align-items-center">
                            <h3 style="margin: auto">{{dop.name}}</h3>
                        </div>

                        <div class="row">
                            <div class="col">
                                <button ng-click="setinfoflag(0)" class=" btn btn-white"><i class="fas fa-chevron-left"></i> List</button>
                            </div>
                            <div class="col">
                                <div class="float-right">
                                    <a target="_blank" ng-href="{{twitter}}"><img height=40 src="http://cs-server.usc.edu:45678/hw/hw8/images/Twitter.png"></a>
                                    <button class="btn btn-white favourite_icon" ng-click='favorite(dop)'><i class="fa-star favourite_icon" ng-class="{'far':!islocal(),'fas':islocal()}"></i></button>
                                </div>
                            </div>
                        </div>



                        <ul style="margin-top: 15px;" class="nav nav-tabs justify-content-end">
                            <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#home">Info</a></li>
                            <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#menu1">Photos</a></li>
                            <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#menu2">Map</a></li>
                            <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#menu3">Reviews</a></li>
                        </ul>

                        <div class="tab-content">
                            <div id="home" role="tabpanel" class="table-responsive tab-pane fade show active">
                                <table class="table table-striped">
                                    <tbody>
                                        <tr>
                                            <th>Address</th>
                                            <td>{{dop.formatted_address}}</td>
                                        </tr>
                                        <tr>
                                            <th>Phone Number</th>
                                            <td>{{dop.international_phone_number}}</td>
                                        </tr>
                                        <tr>
                                            <th>Price Level</th>
                                            <td>{{dop.price_level;}}</td>
                                        </tr>
                                        <tr>
                                            <th>Rating</th>
                                            <td>
                                                <table style="border-color: white; margin-bottom: 0px;">
                                                    <tr style="border-color: white; background-color: white;">
                                                        <td style="border-color: white;padding: 0px;padding-right: 10px;">{{dop.rating}}</td>
                                                        <td style="border-color: white;padding: 0px;padding-right: 10px;">
                                                            <rate-yo rating="dop.rating"></rate-yo>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Google Page</th>
                                            <td><a target="_blank" href="{{dop.url}}">{{dop.url}}</a></td>
                                        </tr>
                                        <tr>
                                            <th>Website</th>
                                            <td><a target="_blank" href="{{dop.website}}">{{dop.website}}</a></td>
                                        </tr>
                                        <tr>
                                            <th>Hours</th>
                                            <td>
                                                <span ng-show="{{dop.opening_hours.open_now}}">Open now: {{dop | gettime:this}}</span>
                                                <span ng-show="{{!dop.opening_hours.open_now}}">Closed</span>
                                                <button style="border: 0px; vertical-align: top; margin:0px; padding: 0px" type="button" class="btn btn-link" data-toggle="modal" data-target="#exampleModalCenter">
                                                  Daily Opening Hours
                                                </button>

                                                <!-- Modal -->
                                                <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered" role="document">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="exampleModalLongTitle">Open Hours</h5>
                                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                          <span aria-hidden="true">&times;</span>
                                                        </button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <table class="table">
                                                                    <tbody>
                                                                        <tr ng-repeat="hours in opening_hours">
                                                                            <td ng-class="{'font-weight-bold':$index==0}">
                                                                                {{hours | split:': ':0}}
                                                                            </td>
                                                                            <td ng-class="{'font-weight-bold':$index==0}">
                                                                                {{hours | split:': ':1}}
                                                                            </td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="menu1" role="tabpanel" class="container tab-pane fade">
                                <div class="alert alert-warning" role="alert" ng-show="isempty(dop.photos)">
                                    No Records.
                                </div>
                                <div class="row img-gallery">
                                    <span style="padding:5px;" class="col-md-3" ng-repeat="i in dop.photos">
                                        <img style="padding:5px;margin:5px" class="img-fluid border rounded" ng-src="{{i}}">
                                    </span>
                                </div>
                            </div>
                            <div id="menu2" role="tabpanel" class="tab-pane fade">
                                <h3>Maps</h3>
                                <form>
                                    <div class="form-row">
                                        <div class="form-group col-md-4">
                                            <label for="fromloc">From</label>
                                            <input autocomplete="off" id="fromloc" class="form-control" g-places-autocomplete ng-model="place" />
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="toloc">To</label>
                                            <input value="{{dop.formatted_address}}" readonly type="text" class="form-control" id="toloc">
                                        </div>
                                        <div class="form-group col-md-2">
                                            <label for="travelmode">Travel Mode</label>
                                            <select class="custom-select mr-sm-2" id="travelmode">
                                                <option value="DRIVING" selected>Driving</option>
                                                <option value="BICYCLING">Bicycling</option>
                                                <option value="TRANSIT">Transit</option>
                                                <option value="WALKING">Walking</option>
                                            </select>
                                        </div>
                                        <div class="form-group col-md-2">
                                            <label for="getdir">&nbsp;</label>
                                            <button ng-click="getDirections()" style="display:block" id="getdir" class="btn btn-primary">Get Directions</button>
                                        </div>
                                    </div>
                                </form>
                                <button class="btn btn-white" ng-click="toggleStreetView()">
                                    <img width=30 ng-src="{{imagelist[togglemap]}}">
                                </button>
                                <div id="map"></div>
                                <div id="right-panel"></div>
                            </div>
                            <div id="menu3" role="tabpanel" class="tab-pane fade">
                                <span class="dropdown">
                                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        {{reviewtype}}
                                    </button>
                                    <div class="dropdown-menu" aria-labelledby="dropdownMenu1">
                                        <button ng-click="setReviewType(0)" class="dropdown-item" type="button">Google Reviews</button>
                                        <button ng-click="setReviewType(1)" class="dropdown-item" type="button">Yelp Reviews</button>
                                    </div>
                                </span>

                                <span class="dropdown">
                                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        {{dropd}}
                                    </button>
                                    <div class="dropdown-menu" aria-labelledby="dropdownMenu2">
                                        <button ng-click="setOrder(0)" class="dropdown-item" type="button">Default Order</button>
                                        <button ng-click="setOrder(1)" class="dropdown-item" type="button">Highest Rating</button>
                                        <button ng-click="setOrder(2)" class="dropdown-item" type="button">Lowest Rating</button>
                                        <button ng-click="setOrder(3)" class="dropdown-item" type="button">Most Recent</button>
                                        <button ng-click="setOrder(4)" class="dropdown-item" type="button">Least Recent</button>

                                    </div>
                                </span>
                                <div class="alert alert-warning" role="alert" ng-show="isempty(yelp.reviews) && reviewshow==1">
                                    No Records.
                                </div>
                                <div ng-show="reviewshow==1" style="margin-top: 15px; padding-top: 15px;padding-bottom: 15px;" class="container-fluid border rounded" ng-repeat="i in yelp.reviews | orderBy: orderPropertyYelp">
                                    <div class="row">
                                        <div class="col-2 col-md-1">
                                            <a target="_blank" ng-href="{{i.url}}">
                                                <img width=50 ng-src="{{i.user.image_url}}">
                                            </a>
                                        </div>
                                        <div class="col-10 col-md-11">
                                            <div>
                                                <a style="padding:0px;" target="_blank" class="btn btn-link" ng-href="{{i.url}}">
                                                    <p style="margin-bottom: 0px;" class="font-weight-bold">{{i.user.name}}</p>
                                                </a>
                                            </div>
                                            <div>
                                                <span ng-repeat="stars in range(i.rating) track by $index">
                                                    <i class="fas fa-star"></i>
                                                </span>
                                                <span> 
                                                    {{i.time_created}}
                                                </span>
                                            </div>
                                            <div>
                                                <p>{{i.text}}</p>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <div class="alert alert-warning" role="alert" ng-show="isempty(dop.reviews) && reviewshow==0">
                                    No Records.
                                </div>
                                <div ng-show="reviewshow==0" style="margin-top: 15px; padding-top: 15px;padding-bottom: 15px;" class="container-fluid border rounded" ng-repeat="i in dop.reviews | orderBy: orderProperty">
                                    <div class="row">
                                        <div class="col-2 col-md-1">
                                            <a target="_blank" ng-href="{{i.author_url}}"><img width=50 ng-src="{{i.profile_photo_url}}"></a>
                                        </div>
                                        <div class="col-10 col-md-11">
                                            <div>
                                                <a style="padding:0px;" target="_blank" class="btn btn-link" ng-href="{{i.author_url}}">
                                                    <p style="margin-bottom: 0px;" class="font-weight-bold">{{i.author_name}}</p>
                                                </a>
                                            </div>
                                            <div>
                                                <span ng-repeat="stars in range(i.rating) track by $index">
                                                    <i class="fas fa-star"></i>
                                                </span>
                                                <span> {{i.time * 1000 | date:'yyyy-MM-dd HH:mm:ss'}}</span>
                                            </div>
                                            <div>
                                                <p>{{i.text}}</p>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>


    <script>
        var myApp = angular.module('myApp', ['google.places', 'ui.bootstrap'])

        myApp.controller('myCtrl', ['$scope', '$http', function($scope, $http) {

            $scope.favs = [];
            $scope.infoflag = 0;
            $scope.resultsPerPage = 5;
            $scope.selectedIndex = 0;

            $scope.imagelist = ['http://cs-server.usc.edu:45678/hw/hw8/images/Pegman.png', 'http://cs-server.usc.edu:45678/hw/hw8/images/Map.png']
            $scope.togglemap = 0;

            $scope.options = {
                ratedFill: '#f00',
                readOnly: true,
                halfStar: false,
                fullStar: false
            };

            $scope.tab = 0;
            $scope.isactive = function(x) {

                if ($scope.tab == x)
                    return true;
                else
                    return false;
            }

            $scope.changeactive = function(x) {
                console.log($scope.tab, x);
                $scope.tab = x;
                $scope.infoflag = 0;
            }

            $scope.clearall = function() {
                $scope.keyword = "";
                $scope.myForm.keyword.$touched = false;

                $scope.category = $scope.types[0];

                $scope.distance = "";

                $scope.radio = "option1";

                $scope.place = "";
                $scope.myForm.place.$touched = false;


                $scope.groups = [];
                $scope.resfav = "res";

                $scope.table = 0;
            }

            $scope.detailsofplace = ['a'];

            $scope.forwardIndex = function() {
                $scope.selectedIndex++;

                console.log($scope.selectedIndex);
            }

            $scope.backwardIndex = function() {
                $scope.selectedIndex--;

                console.log($scope.selectedIndex);
            }

            $scope.updateFavs = function() {

                $scope.favs = [];
                for (let i = 0; i < localStorage.length; i++) {
                    $scope.favs[i] = JSON.parse(localStorage.getItem(localStorage.key(i)));
                }

                //console.log($scope.favs);

            }

            $scope.islocal = function() {

                let key;
                if (this.student == undefined) {
                    key = this.dop['id'];
                } else {
                    key = this.student['id'];
                }


                //console.log($scope.favs);
                //console.log(key);

                if (localStorage[key] == undefined)
                    return false;

                return true;

            }

            $scope.updateFavs();

            $scope.resfav = "res";
            $scope.radio = "option1";
            $scope.done = 0;
            $scope.table = 0;

            $scope.config = {
                itemsPerPage: 5,
                fillLastPage: true
            }

            $scope.types = ['Default', 'Airport', 'Amusement Park', 'Aquarium', 'Art Gallery', 'Bakery', 'Bar', 'Beauty Salon', 'Bowling Alley', 'Bus Station', 'Cafe', 'Campground', 'Car Rental', 'Casino', 'Lodging', 'Movie Theater', 'Museum', 'Night Club', 'Park', 'Parking', 'Restaurant', 'Shopping Mall', 'Stadium', 'Subway Station', 'Taxi Stand', 'Train Station', 'Transit Station', 'Travel Agency', 'Zoo']

            $scope.category = $scope.types[0]
            $scope.hereval = {}

            let url = "http://ip-api.com/json"

            $http.get(url).then(function(response) {
                $scope.hereval.lat = response.data.lat;
                $scope.hereval.lon = response.data.lon;

                var res = JSON.stringify(response.data);
                //console.log(res);
                $scope.done = 1;
            });

            $scope.hereval.lat = "34.0224";
            $scope.hereval.lon = "-118.2851";
            $scope.done = 1;

            $scope.myFunc = function() {
                var url = "nearby"

                $scope.table = 1;
                $scope.infoflag = 0;

                $scope.changeactive(0);

                $scope.location = $scope.hereval.lat + ',' + $scope.hereval.lon;

                let myplace;

                try {
                    myplace = $scope.place['formatted_address'];

                    if (myplace == undefined) {
                        myplace = document.getElementById("place").value;
                    }
                } catch (err) {
                    console.log('aaa');
                    myplace = document.getElementById("place").value;
                }

                //console.log(myplace);

                $http.get(url, {
                    params: {
                        keyword: $scope.keyword,
                        type: $scope.category.split(' ').join('_').toLocaleLowerCase(),
                        location: $scope.location,
                        radius: ($scope.distance || 10) * 1600,
                        radio: $scope.radio,
                        place: myplace.split(' ').join('+')
                    }
                }).then(function(response) {
                    $scope.students = response.data;

                    //console.log($scope.students);

                    $scope.groups = []

                    for (let i = 0; i < $scope.students.length; ++i) {

                        //console.log(i);

                        if (i % $scope.resultsPerPage == 0) {
                            $scope.groups.push([]);
                        }

                        //console.log(i / $scope.resultsPerPage);

                        $scope.groups[Math.floor(i / $scope.resultsPerPage)].push($scope.students[i]);
                    }

                    //console.log($scope.groups);

                    //console.log($scope.students);

                    $scope.table = 2;
                });

            };

            $scope.favorite = function(placeobj) {

                let key;
                if (this.student == undefined) {
                    key = this.dop['id'];
                } else {
                    key = this.student['id'];
                }


                //console.log($scope.favs);
                //console.log(key);

                if (localStorage[key] == undefined) {
                    localStorage.setItem(placeobj['id'], JSON.stringify(placeobj));
                } else {
                    $scope.trash(placeobj);
                }

                $scope.updateFavs();
            };

            $scope.trash = function(placeobj) {

                localStorage.removeItem(placeobj['id']);

                //console.log(placeobj['id']);

                $scope.updateFavs();
            };

            $scope.placedetails = function(pid) {

                $scope.recents = pid;

                var uluru = {
                    lat: 0,
                    lng: 0
                }
                var map = new google.maps.Map(document.getElementById('map'), {
                    center: uluru,
                    zoom: 15
                });
                var marker = new google.maps.Marker({
                    position: uluru,
                    map: map
                });

                var request = {
                    placeId: pid
                };

                console.log(pid);

                service = new google.maps.places.PlacesService(map);
                service.getDetails(request, callback);

                function callback(place, status) {

                    console.log(status);

                    console.log(place);


                    if (status == google.maps.places.PlacesServiceStatus.OK) {
                        //console.log(JSON.stringify(place));
                        $scope.detailsofplace[0] = place;

                        $scope.detailsofplace[0].price_level = '$'.repeat($scope.detailsofplace[0].price_level)


                        for (i in $scope.detailsofplace[0].photos) {
                            $scope.detailsofplace[0].photos[i] = place.photos[i].getUrl({
                                'maxWidth': 500,
                                'maxHeight': 500
                            });
                        }

                        //Yelp

                        let yelpdata = {};
                        let a_comp = place.address_components;

                        console.log(a_comp);

                        //console.log(place);

                        for (var i = 0; i < a_comp.length; ++i) {

                            for (var j = 0; j < a_comp[i]["types"].length; ++j) {
                                if (a_comp[i]["types"][j] == "country") {
                                    yelpdata["country"] = a_comp[i]["short_name"];
                                }
                                if (a_comp[i]["types"][j] == "locality") {
                                    yelpdata["city"] = a_comp[i]["short_name"];
                                }
                                if (a_comp[i]["types"][j] == "administrative_area_level_1") {
                                    yelpdata["state"] = a_comp[i]["short_name"];
                                }
                            }
                        }

                        $http.get("yelpsearch", {
                            params: {
                                name: place.name,
                                city: yelpdata.city,
                                state: yelpdata.state,
                                country: yelpdata.country,
                                address1: place.vicinity,
                                latitude: place.geometry.location.lat(),
                                longitude: place.geometry.location.lng()
                            }
                        }).then(function(response) {
                            $scope.yelp = response.data;
                        });

                        $scope.setOrder(0);
                        $scope.setReviewType(0);
                        $scope.infoflag = 1;
                        $scope.rating = $scope.detailsofplace[0].rating;

                        $scope.twitter = "https://twitter.com/intent/tweet?";

                        $scope.twitter += "text=Check out " + $scope.detailsofplace[0].name + " located at " + $scope.detailsofplace[0].formatted_address + ". Website: ";

                        $scope.twitter += "&url=" + $scope.detailsofplace[0].website;

                        $scope.twitter += "&hashtags=TravelAndEntertainmentSearch";

                        $scope.twitter = encodeURI($scope.twitter);

                        console.log($scope.twitter);

                        $scope.$apply();

                        var uluru = {
                            lat: place.geometry.location.lat(),
                            lng: place.geometry.location.lng()
                        }

                        var map = new google.maps.Map(document.getElementById('map'), {
                            center: uluru,
                            zoom: 15
                        });
                        var marker = new google.maps.Marker({
                            position: uluru,
                            map: map
                        });

                        $scope.uluru = uluru;
                        $scope.mapmap = map;
                        $scope.panorama = map.getStreetView();
                        $scope.panorama.setPosition(uluru);
                        $scope.panorama.setPov( /** @type {google.maps.StreetViewPov} */ ({
                            heading: 265,
                            pitch: 0
                        }));

                        document.getElementById('fromloc').value = "Your Location";
                    }
                }
            }

            $scope.toggleStreetView = function() {

                $scope.togglemap = 1 - $scope.togglemap;

                var map = new google.maps.Map(document.getElementById('map'), {
                    center: $scope.uluru,
                    zoom: 15
                });
                var marker = new google.maps.Marker({
                    position: $scope.uluru,
                    map: map
                });

                $scope.panorama = map.getStreetView();
                $scope.panorama.setPosition($scope.uluru);
                $scope.panorama.setPov( /** @type {google.maps.StreetViewPov} */ ({
                    heading: 265,
                    pitch: 0
                }));

                console.log($scope.panorama);

                //                $scope.panorama.setVisible(true);

                console.log($scope.panorama.getVisible());

                //                var toggle = $scope.panorama.getVisible();
                //                    if (toggle == false) {
                //                      $scope.panorama.setVisible(true);
                //                    } else {
                //                      $scope.panorama.setVisible(false);
                //                    }

                var toggle = $scope.togglemap;
                if (toggle == 1) {
                    $scope.panorama.setVisible(true);
                } else {
                    $scope.panorama.setVisible(false);
                
                    if($scope.getdirtog == 1)
                        $scope.getDirections();

                }
            }

            $scope.getDirections = function() {

                $scope.togglemap = 0;
                $scope.getdirtog = 1;

                var map = new google.maps.Map(document.getElementById('map'));
                var directionsDisplay = new google.maps.DirectionsRenderer;
                var directionsService = new google.maps.DirectionsService;
                directionsDisplay.setMap(map);

                $scope.directionsDisplay = directionsDisplay;

                document.getElementById('right-panel').innerHTML = "";

                directionsDisplay.setPanel(document.getElementById('right-panel'));


                var start = document.getElementById('fromloc').value;

                if (start.toLowerCase() == 'your location' || start.toLocaleLowerCase() == 'my location') {
                    var start = new google.maps.LatLng($scope.hereval.lat, $scope.hereval.lon);
                }

                var end = document.getElementById('toloc').value;
                var tmode = document.getElementById('travelmode').value;

                directionsService.route({
                    origin: start,
                    destination: end,
                    travelMode: tmode,
                    provideRouteAlternatives: true
                }, function(response, status) {
                    if (status === 'OK') {
                        directionsDisplay.setDirections(response);
                    } else {
                        window.alert('Directions request failed due to ' + status);
                    }
                });

            }

            $scope.range = function(x) {
                return new Array(x);
            }

            $scope.setOrder = function(x) {

                let names = ['Default Order', 'Highest Rating', 'Lowest Rating', 'Most Recent', 'Least Recent'];
                let orders = ['', '-rating', 'rating', '-time', 'time'];
                let ordersyelp = ['', '-rating', 'rating', '-time_created', 'time_created'];

                $scope.dropd = names[x];

                $scope.orderProperty = orders[x];
                $scope.orderPropertyYelp = ordersyelp[x];

            }

            $scope.setinfoflag = function(x) {
                $scope.infoflag = x;
            }

            $scope.setReviewType = function(x) {

                let names = ['Google Reviews', 'Yelp Reviews'];

                $scope.reviewtype = names[x];
                $scope.reviewshow = x;
            }

            $scope.isempty = function(array) {
                if (!Array.isArray(array) || !array.length) {
                    return true;
                }

                return false;
            }

            $scope.isrecent = function(pid) {

                if ($scope.recents == pid) {
                    return true;
                }
                return false;
            }

        }]);

        myApp.directive("rateYo", function() {
            return {
                scope: {
                    rating: "="
                },
                template: "<span id='rateYo'></span>",
                link: function(scope, ele, attrs) {
                    $(ele).rateYo({
                        rating: scope.rating,
                        starWidth: "20px",
                        ratedFill: "#ffce59",
                        readOnly: true
                    });
                }
            };
        });


        myApp.filter('split', function() {
            return function(input, splitChar, splitIndex) {

                if (input == undefined) {
                    return;
                }

                let aofstrings = input.split(': ');

                // do some bounds checking here to ensure it has that index
                return aofstrings[splitIndex];
            }
        });

        myApp.filter('gettime', function() {
            return function(input, scope) {


                //console.log(input);

                if (input == undefined || input == 'a') {
                    return;
                }

                let n = new Date();

                let day = moment.utc().utcOffset(parseInt(input.utc_offset)).day();

                //console.log(day);


                if (input.opening_hours == undefined) {
                    console.log("No Hours");
                    return;
                }

                let arr = input.opening_hours.weekday_text;

                let actual_day = (day + 6) % 7;

                scope.opening_hours = arr.slice(actual_day, 7).concat(arr.slice(0, actual_day));

                //console.log(input.opening_hours.weekday_text[actual_day]);

                let aofstrings = input.opening_hours.weekday_text[actual_day].split(': ')[1];

                //console.log(day);
                //console.log(aofstrings);
                //console.log(input.utc_offset);

                // do some bounds checking here to ensure it has that index
                return aofstrings;
            }
        });

    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

</body>

</html>
